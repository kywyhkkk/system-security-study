**测试 EFS（加密文件系统）文件漫游** 

在测试过程中因为windows的加密服务需要购买，未对文件使用wiendows的加密服务。

### 测试 EFS 文件漫游的步骤

#### 1. 前提条件
- **域环境**：需要一个 Active Directory 域，所有客户端计算机都加入域。
- **漫游配置文件**：已在 Active Directory 中为用户配置了漫游配置文件。
- **EFS 支持**：Windows 服务器和客户端系统支持 EFS 加密功能（如 Windows 10 专业版、Windows Server 2016/2019）。这里我使用的是windows2022

#### 2. 配置漫游用户

首先，确保用户已经启用了漫游配置文件，如先前提到的步骤。用户登录不同设备时，可以加载其桌面、文档和应用程序配置。

#### 3. 配置 EFS 加密文件

1. **在客户端计算机上启用 EFS 加密**：
   - 登录到一台已经加入域的客户端计算机（如 Windows 10 工作站）并以配置了漫游的用户身份登录。
   
2. **加密文件或文件夹**：
   - 打开文件资源管理器，找到你想要加密的文件或文件夹（例如 `Documents` 文件夹中的某个文件）。
   - 右键点击文件或文件夹，选择 **“属性”**。
   - 在 **“常规”** 选项卡中，点击 **“高级”** 按钮。
   - 勾选 **“加密内容以保护数据”** 选项，然后点击“确定”。
   
3. **EFS 加密成功**：
   - 加密完成后，文件或文件夹名称将变为绿色（这是 Windows 的默认设置，表明该文件已加密）。

#### 4. 测试文件漫游

1. **在第二台计算机上登录**：这里我是通过虚拟机实现
   - 现在，使用相同的用户账户，在第二台域内计算机上登录。
   - 由于启用了漫游配置文件，用户的桌面和文档等信息会自动加载。

2. **检查文件解密**：
   - 在第二台计算机上，打开用户的文档文件夹，找到之前加密的文件或文件夹。
   - 如果配置正确，用户应能像在第一台计算机上一样，正常打开和编辑加密文件。系统会自动解密该文件，因为漫游用户的加密密钥已随用户配置文件漫游。

3. **文件保持加密状态**：
   - 虽然用户可以正常访问文件，但文件在磁盘上依然保持加密状态。其他没有权限的用户（如管理员或其他用户）尝试访问该文件时，会看到拒绝访问的提示。

#### 5. 验证 EFS 文件保护

1. **使用管理员账户访问加密文件**：
   - 作为域管理员，尝试在服务器上直接访问存储用户漫游配置文件的文件夹（例如 `\\server_name\Profiles\username\Documents`）。
   - 即使管理员可以看到文件，除非具备用户的解密权限，否则无法打开或编辑文件。EFS 确保文件在磁盘上仍保持加密状态。

2. **尝试在不同用户下访问**：
   - 使用不同的域用户登录到计算机，尝试访问该加密文件。其他用户将无法解密或访问该文件，确保了数据的安全性。

#### 6. EFS 证书备份和恢复

为了进一步确保加密文件的安全性和可访问性，建议为用户的 EFS 证书进行备份。

1. **备份 EFS 证书**：
   - 在用户的第一台计算机上，打开 **控制面板** -> **用户账户** -> **管理用户证书**。
   - 展开 **个人** -> **证书**，找到用于 EFS 的证书。
   - 右键点击证书，选择 **“所有任务”** -> **“导出”**。
   - 使用向导导出私钥，并将其保存为 `.pfx` 文件。为私钥设置密码，以便在需要时恢复。
   
2. **恢复 EFS 证书**：
   - 如果用户在新设备上无法访问加密文件，可以通过导入 `.pfx` 证书来恢复 EFS 文件的访问权限。
   - 在用户的计算机上，打开 **管理用户证书**，右键点击 **“个人”** -> **“导入”**，选择之前备份的 `.pfx` 文件，并输入密码完成导入。

#### 7. 问题排查

1. **无法解密文件**：
   - 如果用户在其他设备上无法解密文件，可能是由于 EFS 证书没有正确漫游或恢复。在这种情况下，尝试手动导入用户的 EFS 证书。

2. **漫游配置文件同步问题**：
   - 如果用户的漫游配置文件没有正确同步，检查网络连接和文件服务器的可用性。确保用户有正确的文件夹权限，服务器有足够的存储空间来保存配置文件。

3. **权限问题**：
   - 确认漫游用户对漫游配置文件和 EFS 加密文件的访问权限是否正确配置。如果出现权限问题，检查 Active Directory 中的用户权限和组策略设置。
