**VPN（Virtual Private Network，虚拟专用网络）**和**RRAS（Routing and Remote Access Service，路由和远程访问服务）**是 Windows Server 上提供的两种重要服务，帮助用户实现远程访问和网络路由。下面我们将详细介绍如何使用 **RRAS** 来配置 **VPN**，使远程用户能够安全地访问内部网络。

网上看到可以是基于域也可以不用，我就采用了不基于域的。

### 1. 什么是 VPN 和 RRAS？

- **VPN**：VPN 允许用户通过公共网络（如互联网）安全地连接到公司或组织的内部网络，就像他们直接连接到局域网一样。VPN 加密了数据传输，确保数据的安全性和隐私。
  
- **RRAS**：RRAS 是 Windows Server 提供的一个多功能服务，允许服务器作为 VPN 网关或路由器。它支持配置路由、远程访问（如 VPN 和拨号连接），以及多种网络协议的路由。

### 2. 配置 VPN 和 RRAS 的前提条件

- **Windows Server 2016/2019/2022** 服务器角色。我这里用的2022
- **静态 IP 地址**：VPN 服务器需要使用静态 IP 地址，确保用户可以通过固定地址连接到服务器。
- **域或工作组**：服务器可以是域控制器，也可以是独立服务器。
- **防火墙设置**：在服务器的防火墙或路由器上，确保 VPN 所需的端口开放（如 PPTP 使用端口 1723，L2TP 使用 1701 和 500，IKEv2 使用 4500）。

### 3. 在 Windows Server 上配置 RRAS 和 VPN

#### 3.1 安装 RRAS 角色

1. **打开“服务器管理器”**：
   - 登录到 Windows Server，然后打开 **“服务器管理器”**。

2. **添加角色和功能**：
   - 在“服务器管理器”中，点击右上角的 **“管理”** 按钮，选择 **“添加角色和功能”**。
   
3. **选择安装类型**：
   - 在向导中，选择 **“基于角色或基于功能的安装”**，然后点击“下一步”。

4. **选择目标服务器**：
   - 选择你要配置的服务器，并点击“下一步”。

5. **选择服务器角色**：
   - 在角色列表中，勾选 **“远程访问”**，系统将提示安装依赖组件，点击 **“添加功能”**。

6. **添加 RRAS 功能**：
   - 在 **功能** 页面保留默认设置，然后点击“下一步”。
   - 在 **远程访问服务** 角色中，确保勾选 **“路由”** 和 **“DirectAccess 和 VPN (RAS)”** 选项。

7. **确认并安装**：
   - 点击 **“安装”**，等待安装完成。

#### 3.2 配置 RRAS 作为 VPN 服务器

1. **打开 RRAS 管理控制台**：
   - 安装完成后，打开 **“服务器管理器”** -> **“工具”** -> **“路由和远程访问”**。

2. **配置并启用 RRAS**：
   - 在 RRAS 控制台中，右键点击服务器名称，选择 **“配置并启用路由和远程访问”**。
   
3. **选择 VPN 和 NAT 配置**：
   - 在配置向导中，选择 **“自定义配置”**，然后勾选 **“VPN 访问”** 和 **“NAT”**（如果需要网络地址转换）。

4. **配置 IP 地址分配**：
   - 选择如何为 VPN 客户端分配 IP 地址：
     - **自动分配**：系统自动从 DHCP 服务器获取 IP 地址。
     - **手动分配**：您可以指定一个 IP 地址池，RRAS 会从该池中分配 IP 地址给远程用户。

5. **启用安全性和身份验证**：
   - 启用 **Windows 认证**，或者配置 RADIUS 服务器进行身份验证。

6. **完成配置**：
   - 完成后，RRAS 服务将启动，服务器将配置为 VPN 服务器。

#### 3.3 配置 VPN 协议

1. **PPTP（Point-to-Point Tunneling Protocol）**：
   - **PPTP** 是一种简单易用的 VPN 协议，常用于企业的内部网络。
   - 在防火墙中，确保端口 1723 开放，以允许 PPTP 流量。
   
2. **L2TP/IPsec（Layer 2 Tunneling Protocol over IPsec）**：
   - **L2TP** 提供更高的安全性，通过 IPsec 协议加密传输。
   - 确保防火墙开放以下端口：
     - UDP 1701：L2TP 流量。
     - UDP 500 和 4500：IPsec 流量。
     - ESP（IP协议 50）：IPsec 封装的安全负载。

3. **IKEv2（Internet Key Exchange version 2）**：
   - **IKEv2** 是一种更现代化的 VPN 协议，支持更强的加密和连接恢复能力，适用于移动设备。
   - 在防火墙中开放端口 500 和 4500，以支持 IKEv2 流量。

### 4. 配置防火墙和 NAT

1. **打开防火墙端口**：
   - 确保在服务器的防火墙或路由器上，开放所需的 VPN 端口。例如，PPTP 使用 TCP 1723，L2TP 使用 UDP 1701，IKEv2 使用 UDP 500 和 4500。
   
2. **配置 NAT**：
   - 如果需要通过 NAT（网络地址转换）提供 VPN 连接，可以在 RRAS 中配置 **NAT**，并确保外部流量可以正确路由到内网资源。

### 5. 创建 VPN 用户账户

1. **Active Directory 用户和计算机**：
   - 打开 **Active Directory 用户和计算机**（如果服务器是域控制器），或者使用本地用户账户管理。
   
2. **创建 VPN 用户**：
   - 右键点击 **用户** 容器，选择 **新建用户**，创建一个新的 VPN 用户。
   
3. **配置远程访问权限**：
   - 右键点击用户，选择 **属性**，进入 **拨入** 选项卡。
   - 选择 **允许访问**，以允许用户通过 VPN 远程访问网络。

### 6. 在客户端配置 VPN

1. **Windows 10 客户端配置 VPN**：
   - 打开 **设置** -> **网络和 Internet** -> **VPN** -> **添加 VPN 连接**。
   - 在 VPN 提供程序中选择 **Windows（内置）**，输入 VPN 服务器的名称或 IP 地址。
   - 选择 VPN 类型（如 PPTP 或 L2TP/IPsec），并输入用户的凭据。

2. **测试 VPN 连接**：
   - 尝试从外部网络连接到 VPN 服务器，检查是否可以成功连接到企业内部网络。

### 7. 测试 VPN 连接

1. **客户端连接测试**：
   - 使用配置好的 VPN 客户端进行测试，确保可以通过 VPN 连接到公司内网。
   
2. **远程访问测试**：
   - 在 VPN 连接成功后，尝试访问内网资源，如文件服务器、应用服务器等。

3. **故障排除**：
   - 如果 VPN 连接失败，检查以下问题：
     - VPN 服务器的端口是否正确开放。
     - 用户的远程访问权限是否正确配置。
     - 防火墙和路由器是否正确转发 VPN 流量。

### 8. 安全性增强

1. **启用强加密**：
   - 确保 VPN 连接使用强加密协议（如 L2TP/IPsec 或 IKEv2），并配置 IPsec 使用强密码算法（如 AES-256）。

2. **多因素认证（MFA）**：
   - 为 VPN 用户启用多因素认证，增加一层安全性。可以通过整合 Azure AD 或其他身份验证服务来实现。

3. **VPN 连接日志**：
   - 在 RRAS 中启用详细日志记录，以监控 VPN 连接情况，并能够及时检测并解决潜在的安全问题。
